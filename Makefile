# Makefile –¥–ª—è –∑–∞–ø—É—Å–∫–∞ OS –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∂–µ–ª–µ–∑–µ
# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

# =============================================================================
# –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# =============================================================================

NASM = nasm                    # –ê—Å—Å–µ–º–±–ª–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
QEMU = qemu-system-x86_64     # –≠–º—É–ª—è—Ç–æ—Ä x86_64 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

# –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
ASM_FILE = boot_modern.asm     # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
BIN_FILE = boot_modern.bin     # –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
IMG_FILE = modern_os.img       # –û–±—Ä–∞–∑ –¥–∏—Å–∫–∞ –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏

# =============================================================================
# –û–°–ù–û–í–ù–´–ï –¶–ï–õ–ò –°–ë–û–†–ö–ò
# =============================================================================

# –¶–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
all: build

# –°–±–æ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ –∏–∑ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª
build: $(BIN_FILE)

$(BIN_FILE): $(ASM_FILE)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≥—Ä—É–∑—á–∏–∫–∞..."
	$(NASM) -f bin $(ASM_FILE) -o $(BIN_FILE)
	@echo "‚úÖ –ó–∞–≥—Ä—É–∑—á–∏–∫ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $(BIN_FILE)"

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –¥–∏—Å–∫–∞ (–∏–º–∏—Ç–∞—Ü–∏—è –¥–∏—Å–∫–µ—Ç—ã 1.44MB)
$(IMG_FILE): $(BIN_FILE)
	@echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –¥–∏—Å–∫–∞..."
	# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—Ä–∞–∑ —Ä–∞–∑–º–µ—Ä–æ–º 1.44MB (2880 —Å–µ–∫—Ç–æ—Ä–æ–≤ –ø–æ 512 –±–∞–π—Ç)
	dd if=/dev/zero of=$(IMG_FILE) bs=512 count=2880 status=none
	# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫ –≤ –ø–µ—Ä–≤—ã–π —Å–µ–∫—Ç–æ—Ä (–∑–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Å–µ–∫—Ç–æ—Ä)
	dd if=$(BIN_FILE) of=$(IMG_FILE) bs=512 count=1 conv=notrunc status=none
	@echo "‚úÖ –û–±—Ä–∞–∑ –¥–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω: $(IMG_FILE)"

# =============================================================================
# –ó–ê–ü–£–°–ö –ù–ê –†–ê–ó–ù–´–• –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø–• –ñ–ï–õ–ï–ó–ê
# =============================================================================

# –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∂–µ–ª–µ–∑–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
run: $(IMG_FILE)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∂–µ–ª–µ–∑–µ..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35 \
		-rtc base=localtime \
		-boot order=a \
		-no-reboot

# –ó–∞–ø—É—Å–∫ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é (–¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞)
run-compat: $(IMG_FILE)
	@echo "üîß –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 256M \
		-cpu pentium3 \
		-machine pc-i440fx-2.12 \
		-rtc base=localtime \
		-boot order=a \
		-no-reboot

# –ó–∞–ø—É—Å–∫ —Å —ç–º—É–ª—è—Ü–∏–µ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ Intel –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
run-intel: $(IMG_FILE)
	@echo "üíª –≠–º—É–ª—è—Ü–∏—è Intel –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 1G \
		-cpu Nehalem \
		-machine q35 \
		-rtc base=localtime \
		-boot order=a \
		-no-reboot

# –î–æ–±–∞–≤–∏–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã –¥–∏—Å–ø–ª–µ—è –¥–ª—è macOS
run-cocoa: $(IMG_FILE)
	@echo "üçé –ó–∞–ø—É—Å–∫ —Å Cocoa –¥–∏—Å–ø–ª–µ–µ–º (macOS –Ω–∞—Ç–∏–≤–Ω—ã–π)..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35 \
		-rtc base=localtime \
		-boot order=a \
		-no-reboot \
		-display cocoa

# –ó–∞–ø—É—Å–∫ –±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
run-text: $(IMG_FILE)
	@echo "üìü –ó–∞–ø—É—Å–∫ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35 \
		-rtc base=localtime \
		-boot order=a \
		-no-reboot \
		-nographic

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ —Å GDB
debug: $(IMG_FILE)
	@echo "üêõ –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏..."
	@echo "–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑: gdb -ex 'target remote :1234'"
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35 \
		-s -S \
		-no-reboot &

# –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
analyze: $(BIN_FILE)
	@echo "üìä –ê–Ω–∞–ª–∏–∑ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞:"
	@echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $$(wc -c < $(BIN_FILE)) –±–∞–π—Ç"
	@echo "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 512 –±–∞–π—Ç (—Ä–∞–∑–º–µ—Ä —Å–µ–∫—Ç–æ—Ä–∞)"
	@echo "–°–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞: $$((512 - $$(wc -c < $(BIN_FILE)))) –±–∞–π—Ç"
	@echo ""
	@echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–∞–π—Ç—ã —Ñ–∞–π–ª–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ 0x55AA):"
	@hexdump -C $(BIN_FILE) | tail -2

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –ó–ê–ì–†–£–ó–û–ß–ù–´–• –ù–û–°–ò–¢–ï–õ–ï–ô
# =============================================================================

# –°–æ–∑–¥–∞–Ω–∏–µ USB-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –æ–±—Ä–∞–∑–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ñ–ª–µ—à–∫—É
usb: $(BIN_FILE)
	@echo "üîå –°–æ–∑–¥–∞–Ω–∏–µ USB –æ–±—Ä–∞–∑–∞..."
	dd if=/dev/zero of=bootable_usb.img bs=1M count=32 status=none
	dd if=$(BIN_FILE) of=bootable_usb.img bs=512 count=1 conv=notrunc status=none
	@echo "‚úÖ USB –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω: bootable_usb.img"
	@echo ""
	@echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ñ–ª–µ—à–∫—É:"
	@echo "   1. –ù–∞–π–¥–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: lsblk"
	@echo "   2. –ó–∞–ø–∏—à–∏—Ç–µ: sudo dd if=bootable_usb.img of=/dev/sdX bs=1M"
	@echo "   –≥–¥–µ sdX - –≤–∞—à–∞ —Ñ–ª–µ—à–∫–∞ (–±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!)"

# =============================================================================
# –ü–†–û–í–ï–†–ö–ê –ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
# =============================================================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
check:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:"
	@which $(NASM) >/dev/null && echo "‚úÖ NASM –Ω–∞–π–¥–µ–Ω: $$(which $(NASM))" || echo "‚ùå NASM –Ω–µ –Ω–∞–π–¥–µ–Ω"
	@which $(QEMU) >/dev/null && echo "‚úÖ QEMU –Ω–∞–π–¥–µ–Ω: $$(which $(QEMU))" || echo "‚ùå QEMU –Ω–µ –Ω–∞–π–¥–µ–Ω"
	@echo ""
	@echo "–í–µ—Ä—Å–∏–∏:"
	@$(NASM) -v 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é NASM"
	@$(QEMU) --version 2>/dev/null | head -1 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é QEMU"

# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç - —Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
test: build run

# =============================================================================
# –û–ß–ò–°–¢–ö–ê –ò –ü–û–ú–û–©–¨
# =============================================================================

# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤..."
	rm -f $(BIN_FILE) $(IMG_FILE) bootable_usb.img
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°–ø—Ä–∞–≤–∫–∞ –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º
help:
	@echo "üöÄ –°–ò–°–¢–ï–ú–ê –°–ë–û–†–ö–ò –î–õ–Ø –°–û–í–†–ï–ú–ï–ù–ù–û–ì–û –ñ–ï–õ–ï–ó–ê"
	@echo "=========================================="
	@echo ""
	@echo "üì¶ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:"
	@echo "  make build     - –°–æ–±—Ä–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫"
	@echo "  make run       - –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∂–µ–ª–µ–∑–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
	@echo "  make test      - –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—Å–æ–±—Ä–∞—Ç—å + –∑–∞–ø—É—Å—Ç–∏—Ç—å)"
	@echo ""
	@echo "‚öôÔ∏è  –†–ï–ñ–ò–ú–´ –ó–ê–ü–£–°–ö–ê:"
	@echo "  make run-compat - –†–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∂–µ–ª–µ–∑–æ–º"
	@echo "  make run-intel  - –≠–º—É–ª—è—Ü–∏—è Intel –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"
	@echo "  make run-cocoa  - –ù–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Å–ø–ª–µ–π –¥–ª—è macOS"
	@echo "  make run-text   - –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ –≥—Ä–∞—Ñ–∏–∫–∏)"
	@echo "  make debug      - –ó–∞–ø—É—Å–∫ —Å –æ—Ç–ª–∞–¥—á–∏–∫–æ–º GDB"
	@echo ""
	@echo "üîß –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:"
	@echo "  make usb       - –°–æ–∑–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–æ—á–Ω—É—é —Ñ–ª–µ—à–∫—É"
	@echo "  make analyze   - –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞"
	@echo "  make check     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"
	@echo "  make clean     - –£–¥–∞–ª–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo ""
	@echo "üí° –î–ª—è –Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: make test"

# –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–∏ —Ü–µ–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç —Ñ–∞–π–ª—ã
.PHONY: all build run run-compat run-intel debug analyze usb check test clean help

# =============================================================================
# –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø
# =============================================================================

# –≠—Ç–æ—Ç Makefile –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞:
#
# 1. QEMU –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–∞—à–∏–Ω—É q35 (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è) –≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π pc
# 2. –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä qemu64 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 64-–±–∏—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
# 3. –ü–∞–º—è—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–æ 512MB-1GB –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
# 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ KVM –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
# 5. GTK –¥–∏—Å–ø–ª–µ–π –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
#
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏:
# 1. NASM –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç .asm –≤ .bin (—á–∏—Å—Ç—ã–π –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥)
# 2. dd —Å–æ–∑–¥–∞–µ—Ç –æ–±—Ä–∞–∑ –¥–∏—Å–∫–∞ –∏ –ø–æ–º–µ—â–∞–µ—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫ –≤ –ø–µ—Ä–≤—ã–π —Å–µ–∫—Ç–æ—Ä
# 3. QEMU –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—Ä–∞–∑ –∫–∞–∫ –¥–∏—Å–∫–µ—Ç—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
#
# –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∂–µ–ª–µ–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make usb' –∏ –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –Ω–∞ —Ñ–ª–µ—à–∫—É