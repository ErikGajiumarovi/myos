# Makefile –¥–ª—è MyOS - –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å —è–¥—Ä–æ–º –Ω–∞ C
# =============================================================================
# –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# =============================================================================

NASM = nasm
QEMU = qemu-system-x86_64
CC = i686-elf-gcc
LD = i686-elf-ld

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞
ifeq (, $(shell which $(CC) 2>/dev/null))
    CC = gcc
    LD = ld
    CFLAGS += -m32
    LDFLAGS += -m elf_i386
endif

# –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CFLAGS = -std=gnu99 -ffreestanding -O2 -Wall -Wextra -fno-stack-protector -fno-pic -mno-sse -mno-sse2
LDFLAGS = -T linker.ld -nostdlib

# –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
BOOT_ASM = boot_modern.asm
STAGE2_ASM = boot_stage2.asm
KERNEL_C = kernel.c
KERNEL_H = kernel.h

BOOT_BIN = boot_modern.bin
STAGE2_BIN = boot_stage2.bin
KERNEL_OBJ = kernel.o
KERNEL_BIN = kernel.bin

IMG_FILE = modern_os.img

# =============================================================================
# –û–°–ù–û–í–ù–´–ï –¶–ï–õ–ò –°–ë–û–†–ö–ò
# =============================================================================

all: $(IMG_FILE)

# –°–±–æ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
$(BOOT_BIN): $(BOOT_ASM)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≥—Ä—É–∑—á–∏–∫–∞..."
	$(NASM) -f bin $(BOOT_ASM) -o $(BOOT_BIN)

# –°–±–æ—Ä–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —ç—Ç–∞–ø–∞
$(STAGE2_BIN): $(STAGE2_ASM)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –≤—Ç–æ—Ä–æ–≥–æ —ç—Ç–∞–ø–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞..."
	$(NASM) -f bin $(STAGE2_ASM) -o $(STAGE2_BIN)

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è —è–¥—Ä–∞ C
$(KERNEL_OBJ): $(KERNEL_C) $(KERNEL_H)
	@echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è —è–¥—Ä–∞ C..."
	$(CC) $(CFLAGS) -c $(KERNEL_C) -o $(KERNEL_OBJ)

# –õ–∏–Ω–∫–æ–≤–∫–∞ —è–¥—Ä–∞
$(KERNEL_BIN): $(KERNEL_OBJ)
	@echo "üîó –õ–∏–Ω–∫–æ–≤–∫–∞ —è–¥—Ä–∞..."
	$(LD) $(LDFLAGS) $(KERNEL_OBJ) -o $(KERNEL_BIN)

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –¥–∏—Å–∫–∞
$(IMG_FILE): $(BOOT_BIN) $(STAGE2_BIN) $(KERNEL_BIN)
	@echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –¥–∏—Å–∫–∞..."
	# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—Ä–∞–∑ 10MB
	dd if=/dev/zero of=$(IMG_FILE) bs=512 count=20480 status=none
	# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫ –≤ –ø–µ—Ä–≤—ã–π —Å–µ–∫—Ç–æ—Ä
	dd if=$(BOOT_BIN) of=$(IMG_FILE) bs=512 count=1 conv=notrunc status=none
	# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –≤–æ –≤—Ç–æ—Ä–æ–π —Å–µ–∫—Ç–æ—Ä
	dd if=$(STAGE2_BIN) of=$(IMG_FILE) bs=512 count=1 seek=1 conv=notrunc status=none
	# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —è–¥—Ä–æ –Ω–∞—á–∏–Ω–∞—è —Å —Å–µ–∫—Ç–æ—Ä–∞ 10
	dd if=$(KERNEL_BIN) of=$(IMG_FILE) bs=512 seek=10 conv=notrunc status=none
	@echo "‚úÖ –û–±—Ä–∞–∑ –¥–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω: $(IMG_FILE)"

# =============================================================================
# –ó–ê–ü–£–°–ö –ò –û–¢–õ–ê–î–ö–ê
# =============================================================================

run: $(IMG_FILE)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ MyOS..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35

debug: $(IMG_FILE)
	@echo "üêõ –ó–∞–ø—É—Å–∫ MyOS –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏..."
	$(QEMU) -drive format=raw,file=$(IMG_FILE) \
		-m 512M \
		-cpu qemu64 \
		-machine q35 \
		-s -S

# =============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –ö–†–û–°–°-–ö–û–ú–ü–ò–õ–Ø–¢–û–†–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è macOS)
# =============================================================================

install-cross-compiler:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –¥–ª—è i686-elf..."
	@echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è..."
	brew install i686-elf-gcc

# =============================================================================
# –û–ß–ò–°–¢–ö–ê
# =============================================================================

clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏..."
	rm -f *.bin *.o *.img

.PHONY: all run debug clean install-cross-compiler
